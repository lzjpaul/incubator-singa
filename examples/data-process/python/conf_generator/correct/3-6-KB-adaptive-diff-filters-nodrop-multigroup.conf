# concate_dim: 1 in sake of speed
# different filter numbers for different groups
# no dropout layer, no fully connected
# filter_num: 10 times the number!!
name: "NUHALLCOND-cnn-KB-adaptive"
neuralnet {
layer {
  name: "data0"
  include: kTrain
  type: kMultidstInput
  partition_dim: 0
  store_conf {
    backend: "kvfile"
    path: "/ssd/zhaojing/cnn/NUHALLCOND/subsample1/normrange_1src_KB/train_data.bin"
    batchsize: 100
    shape: 1
    shape: 12
    shape: 1253
    group1_dim: 366
    group2_dim: 233
    group3_dim: 309
    group4_dim: 345
  }
}
layer {
  name: "data0"
  include: kTest
  type: kMultidstInput
  partition_dim: 0
  store_conf {
    backend: "kvfile"
    path: "/ssd/zhaojing/cnn/NUHALLCOND/subsample1/normrange_1src_KB/test_data.bin"
    batchsize: 97
    shape: 1
    shape: 12
    shape: 1253
    group1_dim: 366
    group2_dim: 233
    group3_dim: 309
    group4_dim: 345
  }
}
layer {
  name: "data0"
  include: kVal
  type: kMultidstInput
  partition_dim: 0
  store_conf {
    backend: "kvfile"
    path: "/ssd/zhaojing/cnn/NUHALLCOND/subsample1/normrange_1src_KB/valid_data.bin"
    batchsize: 97
    shape: 1
    shape: 12
    shape: 1253
    group1_dim: 366
    group2_dim: 233
    group3_dim: 309
    group4_dim: 345
  }
}
layer {
  name: "Group1"
  srclayers: "data0"
  param {
    name: "w1"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b1"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 800
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup1"
  srclayers: "Group1"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup1"
  srclayers: "reluGroup1"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group2"
  srclayers: "data0"
  param {
    name: "w2"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b2"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 800
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup2"
  srclayers: "Group2"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup2"
  srclayers: "reluGroup2"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group3"
  srclayers: "data0"
  param {
    name: "w3"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b3"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 800
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup3"
  srclayers: "Group3"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup3"
  srclayers: "reluGroup3"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group4"
  srclayers: "data0"
  param {
    name: "w4"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b4"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 800
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup4"
  srclayers: "Group4"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup4"
  srclayers: "reluGroup4"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "concatelayer"
  srclayers: "poolGroup1"
  srclayers: "poolGroup2"
  srclayers: "poolGroup3"
  srclayers: "poolGroup4"
  type: kConcate
  concate_conf {
    concate_dim: 3
    num_concates: 4
  }
}

layer {
  name: "ip3"
  srclayers: "concatelayer"
  param {
    name: "wip3"
    init {
      type: kUniform
      low: -0.00527
      high: 0.00527
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "bip3"
    init {
      type: kUniform
      low: -0.00527
      high: 0.00527
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kInnerProduct
  partition_dim: 0
  innerproduct_conf {
    num_output: 2
  }
}

layer {
  name: "softmax2"
  srclayers: "ip3"
  srclayers: "data0"
  # srclayers: "bip3"
  type: kCudnnSoftmaxLoss
  partition_dim: 0
  softmaxloss_conf {
    topk: 1
  }
}

}
train_one_batch {
  alg: kBP
}
train_steps: 12000
disp_freq: 1200
gpu: 1
test_freq: 20
test_steps: 30
validate_freq: 20
validate_steps: 20
checkpoint_freq: 12000
