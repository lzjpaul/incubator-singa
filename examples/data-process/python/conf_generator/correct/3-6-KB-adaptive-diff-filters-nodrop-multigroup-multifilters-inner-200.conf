# concate_dim: 1 in sake of speed
# different filter numbers for different groups
# no dropout layer, no fully connected
# filter_num: 10 times the number!!
name: "NUHALLCOND-cnn-KB-adaptive"
neuralnet {
layer {
  name: "data0"
  include: kTrain
  type: kMultidstInput
  partition_dim: 0
  store_conf {
    backend: "kvfile"
    path: "/ssd/zhaojing/cnn/NUHALLCOND/subsample1/normrange_1src_KB/train_data.bin"
    batchsize: 100
    shape: 1
    shape: 12
    shape: 1253
    group1_dim: 366
    group2_dim: 233
    group3_dim: 309
    group4_dim: 345
  }
}
layer {
  name: "data0"
  include: kTest
  type: kMultidstInput
  partition_dim: 0
  store_conf {
    backend: "kvfile"
    path: "/ssd/zhaojing/cnn/NUHALLCOND/subsample1/normrange_1src_KB/test_data.bin"
    batchsize: 97
    shape: 1
    shape: 12
    shape: 1253
    group1_dim: 366
    group2_dim: 233
    group3_dim: 309
    group4_dim: 345
  }
}
layer {
  name: "data0"
  include: kVal
  type: kMultidstInput
  partition_dim: 0
  store_conf {
    backend: "kvfile"
    path: "/ssd/zhaojing/cnn/NUHALLCOND/subsample1/normrange_1src_KB/valid_data.bin"
    batchsize: 97
    shape: 1
    shape: 12
    shape: 1253
    group1_dim: 366
    group2_dim: 233
    group3_dim: 309
    group4_dim: 345
  }
}
layer {
  name: "Group1"
  srclayers: "data0"
  param {
    name: "w1"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b1"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup1"
  srclayers: "Group1"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup1"
  srclayers: "reluGroup1"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group2"
  srclayers: "data0"
  param {
    name: "w2"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b2"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup2"
  srclayers: "Group2"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup2"
  srclayers: "reluGroup2"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group3"
  srclayers: "data0"
  param {
    name: "w3"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b3"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup3"
  srclayers: "Group3"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup3"
  srclayers: "reluGroup3"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group4"
  srclayers: "data0"
  param {
    name: "w4"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b4"
    init {
      type: kUniform
      low: -0.13693064
      high: 0.13693064
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 80
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup4"
  srclayers: "Group4"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup4"
  srclayers: "reluGroup4"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group1f1"
  srclayers: "data0"
  param {
    name: "w1f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b1f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 140
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup1f1"
  srclayers: "Group1f1"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup1f1"
  srclayers: "reluGroup1f1"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group2f1"
  srclayers: "data0"
  param {
    name: "w2f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b2f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 140
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup2f1"
  srclayers: "Group2f1"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup2f1"
  srclayers: "reluGroup2f1"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group3f1"
  srclayers: "data0"
  param {
    name: "w3f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b3f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 140
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup3f1"
  srclayers: "Group3f1"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup3f1"
  srclayers: "reluGroup3f1"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "Group4f1"
  srclayers: "data0"
  param {
    name: "w4f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "b4f1"
    init {
      type: kUniform
      low: -0.10350983
      high: 0.10350983
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kCudnnConv
  partition_dim: 0
  convolution_conf {
    num_filters: 400
    kernel_x: 140
    kernel_y: 2
    pad_x: 0
    pad_y: 0
    stride_x: 25
    stride_y: 1
  }
}
layer {
  name: "reluGroup4f1"
  srclayers: "Group4f1"
  type: kCudnnActivation
  partition_dim: 0
  activation_conf {
    type: RELU
  }
}
layer {
  name: "poolGroup4f1"
  srclayers: "reluGroup4f1"
  type: kCudnnPool
  partition_dim: 0
  pooling_conf {
    kernel_y: 2
    kernel_x: 2
    pool: MAX
    pad: 0
    stride: 1
  }
}

layer {
  name: "concatelayer"
  srclayers: "poolGroup1"
  srclayers: "poolGroup2"
  srclayers: "poolGroup3"
  srclayers: "poolGroup4"
  srclayers: "poolGroup1f1"
  srclayers: "poolGroup2f1"
  srclayers: "poolGroup3f1"
  srclayers: "poolGroup4f1"
  type: kConcate
  concate_conf {
    concate_dim: 3
    num_concates: 8
  }
}

layer {
  name: "ip1"
  srclayers: "concatelayer"
  param {
    name: "wip1"
    init {
      type: kUniform
      low: -0.004011
      high: 0.004011
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "bip1"
    init {
      type: kUniform
      low: -0.004011
      high: 0.004011
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kInnerProduct
  partition_dim: 0
  innerproduct_conf {
    num_output: 1000
  }
}

layer {
    name: "reluip1"
    type: kCudnnActivation
    activation_conf {
      type: RELU
    }
    # share_src_blobs: true
    srclayers: "ip1"
}

#layer {
#  name: "ip2"
#  srclayers: "reluip1"
#  param {
#    name: "wip2"
#    init {
#      type: kUniform
#      low: -0.053452248
#      high: 0.053452248
#    }
#    lr_scale: 1
#    wd_scale: 1
#  }
#  param {
#    name: "bip2"
#    init {
#      type: kUniform
#      low: -0.053452248
#      high: 0.053452248
#    }
#    lr_scale: 1
#    wd_scale: 1
#  }
#  type: kInnerProduct
#  partition_dim: 0
#  innerproduct_conf {
#    num_output: 100
#  }
#}

#layer {
#    name: "reluip2"
#    type: kCudnnActivation
#    activation_conf {
#      type: RELU
#    }
#    # share_src_blobs: true
#    srclayers: "ip2"
#}


layer {
  name: "ip3"
  # srclayers: "reluip2"
  srclayers: "reluip1"
  param {
    name: "wip3"
    init {
      type: kUniform
      low: -0.05
      high: 0.05
    }
    lr_scale: 1
    wd_scale: 1
  }
  param {
    name: "bip3"
    init {
      type: kUniform
      low: -0.05
      high: 0.05
    }
    lr_scale: 1
    wd_scale: 1
  }
  type: kInnerProduct
  partition_dim: 0
  innerproduct_conf {
    num_output: 2
  }
}

layer {
  name: "softmax2"
  srclayers: "ip3"
  srclayers: "data0"
  # srclayers: "bip3"
  type: kCudnnSoftmaxLoss
  partition_dim: 0
  softmaxloss_conf {
    topk: 1
  }
}

}
train_one_batch {
  alg: kBP
}
train_steps: 12000
disp_freq: 1200
gpu: 2
test_freq: 20
test_steps: 30
validate_freq: 20
validate_steps: 20
checkpoint_freq: 12000
